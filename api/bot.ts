require("dotenv").config()
import { Bot, InlineKeyboard, webhookCallback } from "grammy"
const { createClient } = require("@supabase/supabase-js")

const supabaseUrl = process.env.SUPABASE_URL
const supabaseKey = process.env.SUPABASE_ANON_KEY
const supabase = createClient(supabaseUrl, supabaseKey)

const token = process.env.TOKEN
if (!token) throw new Error("TOKEN is unset")

const bot = new Bot(token)

const categoryTexts = {
	life: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ê–ª–∫–æ–≥–æ–ª–∏–∫–∏* üóì 10 –∏—é–Ω—è 1935 –≥–æ–¥–∞

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ù–∞—Ä–∫–æ–º–∞–Ω—ã* üóì 5 –æ–∫—Ç—è–±—Ä—è 1953 –≥–æ–¥–∞

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ù–∏–∫–æ—Ç–∏–Ω–æ–∑–∞–≤–∏—Å–∏–º—ã–µ* üóì 1982 –≥–æ–¥—É

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –•–∏–º–∏—á–µ—Å–∫–∏–µ –ó–∞–≤–∏—Å–∏–º—ã–µ* üóì –ø–µ—Ä–≤–∞—è –≥—Ä—É–ø–ø–∞ 1997 –≥–æ–¥

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –¢–∞–±–ª–µ—Ç–æ—á–Ω–∏–∫–∏* üóì –æ—Å–Ω–æ–≤–∞–Ω–∞ –≤ 1972 –≥–æ–¥—É
_(–õ—é–¥–∏ –∏—â—É—â–∏–µ –≤—ã–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏–µ –æ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ—Ü–µ–ø—Ç—É—Ä–Ω—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤)_

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ö–æ–∫–∞–∏–Ω–∏—Å—Ç—ã* üóì –≤ 1982 –≥–æ–¥—É

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ê–¥—Ä–µ–Ω–∞–ª–∏–Ω–æ–≤—ã–µ –ù–∞—Ä–∫–æ–º–∞–Ω—ã*`,
	moms: `
*–ê–ª-–ê–Ω–æ–Ω* üóì 1951 –≥–æ–¥

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –°–æ–∑–∞–≤–∏—Å–∏–º—ã–µ*

*–ê–ª–∞—Ç–∏–Ω* üóì 1951 –≥–æ–¥
_(–ê–ª–∞—Ç–∏–Ω ‚Äì —ç—Ç–æ —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–π –∂–µ –ê–ª-–ê–Ω–æ–Ω, —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Ç–µ–π –∏ –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ –∏–∑ —Å–µ–º–µ–π, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∏–ª–∏ –±—ã–ª–∏ –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.)_

*–ù–∞—Ä-–ê–Ω–æ–Ω* üóì 1971 –≥–æ–¥

*–ò-–ê–Ω–æ–Ω*
_(–ò-–ê–Ω–æ–Ω - —ç—Ç–æ –æ–±—â–µ—Å—Ç–≤–æ –º—É–∂—á–∏–Ω –∏ –∂–µ–Ω—â–∏–Ω, –Ω–∞ —á—å–∏ –∂–∏–∑–Ω–∏ –≤–ª–∏—è–µ—Ç –ø—Ä–æ–±–ª–µ–º–∞ –∏–≥—Ä–æ–º–∞–Ω–∏–∏ –±–ª–∏–∑–∫–∏—Ö.)_

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –°–µ–º—å–∏ –•–∏–º–∏—á–µ—Å–∫–∏ –ó–∞–≤–∏—Å–∏–º—ã—Ö*
    `,
	eda: `
*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ü–µ—Ä–µ–µ–¥–∞—é—â–∏–µ* üóì 1960 –≥–æ–¥–∞

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ö–æ–º–ø—É–ª—å—Å–∏–≤–Ω–æ –ü–µ—Ä–µ–µ–¥–∞—é—â–∏–µ* 

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ —Å –†–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –ü–∏—â–µ–≤–æ–≥–æ –ü–æ–≤–µ–¥–µ–Ω–∏—è* 
    `,
	work: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ç–æ—Ä—ã* 

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –¢—Ä—É–¥–æ–≥–æ–ª–∏–∫–∏* üóì 1983 –≥–æ–¥—É 
  `,
	money: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–æ–ª–∂–Ω–∏–∫–∏* üóì 1971

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ù–µ–¥–æ–∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–µ* 

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ë–∏–∑–Ω–µ—Å –î–æ–ª–∂–Ω–∏–∫–∏*
  `,
	soul: `
*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—ã*

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –î–µ–ø—Ä–µ—Å—Å–∏–≤–Ω—ã–µ*`,
	sex: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –°–µ–∫—Å–æ–≥–æ–ª–∏–∫–∏* üóì 1979 –≥–æ–¥—É

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –õ—é–±–æ–≤–Ω–æ–∑–∞–≤–∏—Å–∏–º—ã–µ* üóì 1976 –≥–æ–¥—É

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –°–µ–∫—Å—É–∞–ª—å–Ω–æ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–µ* üóì 1993 –≥–æ–¥—É

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –°–µ–∫—Å—É–∞–ª—å–Ω—ã–µ –ö–æ–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ –õ–∏—á–Ω–æ—Å—Ç–∏* üóì 1982 –≥–æ–¥—É
  `,
	world: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ó–∞–≤–∏—Å–∏–º—ã–µ*

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –ò–≥—Ä–æ–∫–∏*

*–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ú–µ–¥–∏—è –ó–∞–≤–∏—Å–∏–º—ã–µ*
`,
	azart: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ò–≥—Ä–æ–∫–∏* üóì 1957 –≥–æ–¥—É
  `,
	tra: `
  *–í–∑—Ä–æ—Å–ª—ã—Ö –î–µ—Ç–µ–π –∏–∑ –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã—Ö/ –î–∏—Å—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–µ–º–µ–π* üóì 1978 –≥–æ–¥—É
  `,
	art: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –•—É–¥–æ–∂–Ω–∏–∫–∏* üóì 1985 –≥–æ–¥—É
  `,
	dream: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã—Ö –î–µ–π–¥—Ä–∏–º–µ—Ä–æ–≤* üóì 2008 –≥–æ–¥—É
  `,
	bol: `
  *–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –û–Ω–≥–æ–ª–∏–∫–∏*
  `,
}

function buildMainMenuKeyboard() {
	return new InlineKeyboard()
		.text("üçæ –í–µ—â–µ—Å—Ç–≤–∞", "life")
		.row()
		.text("ü´Ç –†–æ–¥—Å—Ç–≤–µ–Ω–∏–∫–∞–º", "moms")
		.text("üßí –¢—Ä–∞–≤–º—ã", "tra")
		.row()
		.text("üôè –ë–æ–ª–µ–∑–Ω–∏", "bol")
		.text("üéÇ –ü–µ—Ä–µ–µ–¥–∞–Ω–∏–µ", "eda")
		.text("üíº –†–∞–±–æ—Ç–∞", "work")
		.row()
		.text("üí∂ –î–µ–Ω—å–≥–∏", "money")
		.text("üé≠ –≠–º–æ—Ü–∏–∏", "soul")
		.text("‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è", "sex")
		.row()
		.text("üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç", "world")
		.text("üé≤ –ê–∑–∞—Ä—Ç", "azart")
		.text("üåÖ –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ", "art")
		.row()
		.text("üéÜ –ú–µ—á—Ç–∞—Ç–µ–ª–∏", "dream")
}

const mainMsg = `
–ë–æ–ª–µ–µ 60 –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö *12-—Ç–∏ —à–∞–≥–æ–≤—ã—Ö* —Å–æ–æ–±—â–µ—Å—Ç–≤.
[–°—Å—ã–ª–∫–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤](https://t.me/all12_contacts)
`

bot.command("start", ctx => {
	const keyboard = buildMainMenuKeyboard()
	ctx.reply(mainMsg, {
		reply_markup: keyboard,
		parse_mode: "Markdown",
	})
})

async function fetchData() {
	const { data, error } = await supabase.from("tgBotMsg").select("message") // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫—É message

	if (error) {
		console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö:", error)
		throw error // –ü–µ—Ä–µ–¥–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –µ–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤ –±–ª–æ–∫–µ catch
	}

	return data
}

bot.command("sb", async ctx => {
	try {
		const data = await fetchData()
		if (data.length === 0) {
			// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
			await ctx.reply("–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.")
		} else {
			// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
			const messages = data
				.map((item, index) => `${index + 1}: ${item.message}`)
				.join("\n")
			await ctx.reply(`–î–∞–Ω–Ω—ã–µ –∏–∑ Supabase:\n${messages}`)
		}
	} catch (error) {
		console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", error)
		await ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
	}
})

bot.callbackQuery("back_main", async ctx => {
	await ctx.answerCallbackQuery()
	const keyboard = buildMainMenuKeyboard()
	ctx.editMessageText(mainMsg, {
		reply_markup: keyboard,
		parse_mode: "Markdown",
	})
})

bot.on("callback_query", async ctx => {
	const callbackData = ctx.callbackQuery.data
	await ctx.answerCallbackQuery() // –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ callback-–∑–∞–ø—Ä–æ—Å—ã

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
	if (categoryTexts[callbackData]) {
		const backKeyboard = new InlineKeyboard().text("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")
		await ctx.editMessageText(categoryTexts[callbackData], {
			reply_markup: backKeyboard,
			parse_mode: "Markdown",
		})
	} else if (callbackData === "back_main") {
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
		// –ó–¥–µ—Å—å –≤–∞—à –∫–æ–¥ –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
	} else {
		await ctx.reply("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
	}
})

export default webhookCallback(bot, "https")
